<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê²©ë¦¬ì‹¤ - ì„œëì˜ ë¹„ë°€</title>
  <link rel="stylesheet" href="../style.css" />
  <script src="../inventory.js"></script>
  <script src="../journal.js"></script>
</head>
<body>
  <div class="game-layout">
    <!-- ì™¼ìª½ ê²Œì„ ì˜ì—­ -->
    <div class="game-area">
      <!-- ê·¸ë¦¼ ì˜ì—­ -->
      <div class="image-area">
        <img src="../IMG/ê²©ë¦¬ì‹¤.png" alt="ê²©ë¦¬ì‹¤" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
      </div>

      <!-- ê²Œì„ ì»¨í…Œì´ë„ˆ -->
      <div id="game-container">
        <div id="scene-text">
          ê²©ë¦¬ì‹¤ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤. ì´ê³³ì€ ì‹¤í—˜ì²´ë“¤ì„ ê´€ì°°í•˜ê³  ì—°êµ¬í•˜ëŠ” ê³³ì¸ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
        </div>

        <div id="dialogue" class="dialogue"></div>

        <div id="puzzle-container" class="puzzle" style="display:none;">
          <h3 style="color: #4a9eff; margin-bottom: 15px;">ğŸ”’ ì„œëì˜ ë¹„ë°€ë²ˆí˜¸</h3>
          <p style="margin-bottom: 20px; color: #e8f4fd;">ì•„ë˜ ë‹¨ì„œë“¤ì„ í™•ì¸í•˜ì—¬ 4ìë¦¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì°¾ìœ¼ì„¸ìš”:</p>
          
          <div id="pieces" style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
          
          <div style="text-align: center; margin: 20px 0;">
            <input type="text" id="codeInput" placeholder="4ìë¦¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" maxlength="4" style="
              padding: 12px 20px;
              font-size: 18px;
              border: 2px solid #4a9eff;
              border-radius: 10px;
              background: rgba(74, 158, 255, 0.1);
              color: #e8f4fd;
              text-align: center;
              width: 200px;
              margin-right: 10px;
            " />
            <button onclick="checkCode()" style="
              padding: 12px 24px;
              font-size: 16px;
              background: linear-gradient(135deg, #4a9eff 0%, #2980b9 100%);
              color: white;
              border: none;
              border-radius: 10px;
              cursor: pointer;
              font-weight: 600;
              transition: all 0.3s ease;
            ">í™•ì¸</button>
          </div>
          
          <div id="puzzleMessage" class="message" style="
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            min-height: 20px;
          "></div>
        </div>

        <div id="message"></div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
      <!-- ì¸ë²¤í† ë¦¬ì™€ ì¼ì§€ê°€ ì—¬ê¸°ì— ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
  </div>

  <style>
    .dialogue {
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.1) 0%, rgba(41, 128, 185, 0.1) 100%);
      border: 1px solid rgba(74, 158, 255, 0.3);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      color: #4a9eff;
      font-size: 16px;
      line-height: 1.6;
      backdrop-filter: blur(10px);
    }

    .puzzle {
      background: linear-gradient(145deg, rgba(26, 26, 46, 0.9) 0%, rgba(22, 33, 62, 0.9) 100%);
      border: 2px solid rgba(74, 158, 255, 0.4);
      border-radius: 20px;
      padding: 30px;
      margin: 20px 0;
      backdrop-filter: blur(15px);
    }

    #pieces button {
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.2) 0%, rgba(41, 128, 185, 0.2) 100%);
      border: 2px solid rgba(74, 158, 255, 0.4);
      border-radius: 12px;
      padding: 15px;
      color: #e8f4fd;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: left;
      line-height: 1.4;
    }

    #pieces button:hover {
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.3) 0%, rgba(41, 128, 185, 0.3) 100%);
      border-color: rgba(74, 158, 255, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(74, 158, 255, 0.3);
    }

    #pieces button:disabled {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(56, 142, 60, 0.3) 100%);
      border-color: rgba(76, 175, 80, 0.6);
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .message {
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.1) 0%, rgba(41, 128, 185, 0.1) 100%);
      border: 1px solid rgba(74, 158, 255, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }

    input:focus {
      outline: none;
      border-color: #4a9eff;
      box-shadow: 0 0 10px rgba(74, 158, 255, 0.3);
    }

    button:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(74, 158, 255, 0.3);
    }
  </style>

  <script>
    const dialogueDiv = document.getElementById('dialogue');
    const puzzleContainer = document.getElementById('puzzle-container');
    const puzzleMessage = document.getElementById('puzzleMessage');
    const codeInput = document.getElementById('codeInput');
    const piecesDiv = document.getElementById('pieces');
    
    // ê³ ì •ëœ ë¹„ë°€ë²ˆí˜¸ (ì¼ê´€ì„± ë³´ì¥)
    const ROOM6_CODE = "2468";
    
    function getRoom6Hint() {
      const d = ROOM6_CODE.split('').map(n => parseInt(n, 10));
      const sumFirstTwo = d[0] + d[1];
      const diffLastTwo = Math.abs(d[2] - d[3]);
      const firstParity = d[0] % 2 === 0 ? 'ì§ìˆ˜' : 'í™€ìˆ˜';
      return `ğŸ’¡ íŒíŠ¸: ì• ë‘ ìë¦¬ í•©ì€ ${sumFirstTwo}, ë’¤ ë‘ ìë¦¬ ì°¨ëŠ” ${diffLastTwo}, ì²«ì§¸ëŠ” ${firstParity}`;
    }

    // í”Œë ˆì´ì–´ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
    const mentalState = localStorage.getItem('mentalState') || 'neutral';

    // ëŒ€ì‚¬ ë¶„ê¸° (ìŠ¤í† ë¦¬ íë¦„ ê°œì„ )
    const dialogues = {
      anger: [
        "ë¶„ë…¸ê°€ ê°€ë“ ì°¬ ë‹¹ì‹ ì€, ì´ê³³ì—ì„œ íƒˆì¶œí•  ë°©ë²•ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.",
        "ì´ ê²©ë¦¬ì‹¤ì˜ ì„œë ì•ˆì— ì¤‘ìš”í•œ ë‹¨ì„œê°€ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤...",
        "ì‹¤í—˜ìë“¤ì´ ë‚¨ê²¨ë‘” í”ì ì„ ì°¾ì•„ë³´ê² ìŠµë‹ˆë‹¤."
      ],
      despair: [
        "ì ˆë§ì— ë¹ ì§„ ë‹¹ì‹ ì€, ì›€ì§ì´ê¸°ì¡°ì°¨ í˜ë“­ë‹ˆë‹¤.",
        "í•˜ì§€ë§Œ ì´ ì„œëì„ ì—´ ìˆ˜ ìˆë‹¤ë©´... ë­”ê°€ í¬ë§ì´ ìˆì„ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤.",
        "ë§ˆì§€ë§‰ ê¸°íšŒë¥¼ ì¡ì•„ë³´ê² ìŠµë‹ˆë‹¤."
      ],
      empathy: [
        "ê·¸ë“¤ì„ ì´í•´í•  ìˆ˜ ìˆë‹¤ê³  ìƒê°í•˜ëŠ” ë‹¹ì‹ ì€, ì¹¨ì°©í•˜ê²Œ ì£¼ë³€ì„ ì‚´í•ë‹ˆë‹¤.",
        "ì„œë ì•ˆì— ì—´ì‡ ë‚˜ ì¤‘ìš”í•œ ë‹¨ì„œê°€ ìˆì„ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤.",
        "ì°¨ê·¼ì°¨ê·¼ ì¡°ì‚¬í•´ë³´ê² ìŠµë‹ˆë‹¤."
      ],
      neutral: [
        "ë‹¹ì‹ ì€ ì¹¨ì°©í•˜ê²Œ ì£¼ë³€ì„ ì‚´í•ë‹ˆë‹¤.",
        "ì´ ê²©ë¦¬ì‹¤ì˜ ì„œë ì•ˆì— ì¤‘ìš”í•œ ê²ƒì´ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.",
        "ì²´ê³„ì ìœ¼ë¡œ ì¡°ì‚¬í•´ë³´ê² ìŠµë‹ˆë‹¤."
      ]
    };

    function renderPieces() {
      piecesDiv.innerHTML = '';
      const [d1, d2, d3, d4] = ROOM6_CODE.split('');
      const configs = [
        { 
          label: 'ğŸ”Š ê¸°ê³„ì˜ ê²½ê³ ìŒ', 
          value: d1, 
          text: `ê²½ê³ ìŒ íŒ¨ë„ì— ì†ë•Œ ë¬»ì€ ìˆ«ì '${d1}'ê°€ ë‚¨ì•„ ìˆìŠµë‹ˆë‹¤.` 
        },
        { 
          label: 'ğŸ“º ëª¨ë‹ˆí„°ì˜ ì ë©¸', 
          value: d2, 
          text: `ì§„ë‹¨ ëª¨ë‹ˆí„°ê°€ ì ë©¸í•  ë•Œ, ëª¨ì„œë¦¬ì— ì ê¹ '${d2}'ê°€ ìŠ¤ì¹©ë‹ˆë‹¤.` 
        },
        { 
          label: 'ğŸ“‹ ì—°êµ¬ì¼ì§€ ê°ì£¼', 
          value: d3, 
          text: `ê°ì£¼ ëì— ì íŒ ì‘ì€ ìˆ«ì: ${d3}` 
        },
        { 
          label: 'ğŸ“ ë°”ë‹¥ì˜ í‘œì‹', 
          value: d4, 
          text: `ë°”ë‹¥ í…Œì´í”„ê°€ êµì°¨í•˜ëŠ” ì§€ì ì— ë¶„í•„ë¡œ '${d4}'ê°€ ì“°ì—¬ ìˆìŠµë‹ˆë‹¤.` 
        },
      ];
      
      configs.forEach((c, idx) => {
        const b = document.createElement('button');
        b.innerHTML = `<strong>${c.label}</strong>`;
        b.onclick = () => {
          b.innerHTML = `<strong>${c.label}</strong><br><span style="font-size: 12px; opacity: 0.8;">${c.text}</span>`;
          b.disabled = true;
          
          // ìë™ìœ¼ë¡œ í•´ë‹¹ ìë¦¬ì— ì±„ì›Œ ë„£ê¸°
          const current = codeInput.value.padEnd(4, '_').split('');
          current[idx] = c.value;
          codeInput.value = current.join('').replaceAll('_', '');
          
          // ì¼ì§€ì— ê¸°ë¡ ì¶”ê°€
          addJournalEntry(`${c.label}ì—ì„œ ìˆ«ì ë‹¨ì„œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.`, 'clue');
          
          // ì„±ê³µ ë©”ì‹œì§€
          puzzleMessage.style.color = '#4CAF50';
          puzzleMessage.textContent = `âœ… ${c.label} ë‹¨ì„œ ë°œê²¬!`;
          
          setTimeout(() => {
            puzzleMessage.textContent = '';
          }, 2000);
        };
        piecesDiv.appendChild(b);
      });
    }

    // ëŒ€ì‚¬ ì¶œë ¥ í•¨ìˆ˜ (ìì—°ìŠ¤ëŸ¬ìš´ íƒ€ì´ë°)
    function showDialogue(lines, index = 0) {
      if (index >= lines.length) {
        // ëŒ€ì‚¬ê°€ ëë‚˜ë©´ í¼ì¦ í‘œì‹œ
        setTimeout(() => {
          puzzleContainer.style.display = 'block';
          puzzleMessage.style.color = '#4a9eff';
          puzzleMessage.textContent = getRoom6Hint();
          renderPieces();
          
          // ì„œëì—ì„œ ì•„ì´í…œ ì¶”ê°€
          if (!hasInInventory('ì„œë ì—´ì‡ ')) {
            addToInventory('ì„œë ì—´ì‡ ', 1);
            addJournalEntry('ì„œëì—ì„œ ì—´ì‡ ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ì´ê²ƒìœ¼ë¡œ ë‹¤ë¥¸ ê³³ì„ ì—´ ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.', 'clue');
          }
        }, 1000);
        return;
      }
      
      dialogueDiv.textContent = lines[index];
      setTimeout(() => showDialogue(lines, index + 1), 3000); // 3ì´ˆ ê°„ê²©ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ
    }

    // í¼ì¦ ì •ë‹µ ì²´í¬
    function checkCode() {
      const input = codeInput.value.trim();
      if (input === ROOM6_CODE) {
        puzzleMessage.style.color = '#4CAF50';
        puzzleMessage.textContent = 'ğŸ‰ ì„œëì´ ì—´ë ¸ìŠµë‹ˆë‹¤! ë‹¤ìŒ ë°©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤...';
        addJournalEntry('ì„œëì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë§ì·„ìŠµë‹ˆë‹¤. ì•ˆì—ì„œ ì¤‘ìš”í•œ ë‹¨ì„œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.', 'clue');
        
        setTimeout(() => {
          window.location.href = '../rooms7/operating_room.html';
        }, 3000);
      } else {
        puzzleMessage.style.color = '#f44336';
        puzzleMessage.textContent = 'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        addJournalEntry('ì„œëì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¨ì„œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì•¼ê² ìŠµë‹ˆë‹¤.', 'observation');
        
        setTimeout(() => {
          puzzleMessage.textContent = getRoom6Hint();
        }, 2000);
      }
    }

    // Enter í‚¤ë¡œë„ í™•ì¸ ê°€ëŠ¥
    codeInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        checkCode();
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ€ì‚¬ ì‹œì‘
    window.addEventListener('load', () => {
      const currentDialogue = dialogues[mentalState] || dialogues.neutral;
      showDialogue(currentDialogue);
    });
  </script>
  </body>
  </html>